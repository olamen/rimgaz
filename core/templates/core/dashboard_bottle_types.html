{% extends "core/dashboard_base.html" %}

{% block page_title %}Types de bouteilles{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h1 class="h4 mb-0">Types de bouteilles</h1>
        <button type="button" id="show-bottle-type-create" class="btn btn-sm btn-success">Nouveau type</button>
    </div>
</div>

<div class="row mb-3 d-none" id="bottle-type-create-row">
    <div class="col-lg-8">
        <div class="card card-outline card-success">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Ajouter / modifier un type de bouteille</h3>
                <button type="button" class="btn btn-tool" id="hide-bottle-type-create"><i class="fas fa-times"></i></button>
            </div>
            <div class="card-body">
                <form id="bottle-type-form" class="row g-2 align-items-end">
                    <input type="hidden" id="bt-id">
                    <div class="col-md-4">
                        <label class="form-label">Nom *</label>
                        <input type="text" class="form-control" id="bt-name" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Capacité (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="bt-capacity" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Prix (MRU)</label>
                        <input type="number" step="0.01" class="form-control" id="bt-price" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Caution (MRU)</label>
                        <input type="number" step="0.01" class="form-control" id="bt-deposit" required>
                    </div>
                    <div class="col-12 mt-2">
                        <button type="submit" class="btn btn-success">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card card-primary card-outline">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Liste des types de bouteilles</h3>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover" id="bottle-types-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Capacité (kg)</th>
                            <th>Prix (MRU)</th>
                            <th>Caution (MRU)</th>
                            <th style="width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function loadBottleTypes() {
    const res = await fetch(apiBase + 'bottle-types/');
    if (!res.ok) return;
    const data = await res.json();
    const tbody = document.querySelector('#bottle-types-table tbody');
    tbody.innerHTML = '';
    data.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.name}</td>
            <td>${t.capacity_kg}</td>
            <td>${t.price_mru}</td>
            <td>${t.deposit_mru}</td>
            <td><button type="button" class="btn btn-xs btn-outline-primary bottle-type-edit" data-id="${t.id}" data-name="${t.name}" data-capacity="${t.capacity_kg}" data-price="${t.price_mru}" data-deposit="${t.deposit_mru}"><i class="fas fa-edit"></i></button></td>
        `;
        tbody.appendChild(tr);
    });

    const editButtons = document.querySelectorAll('.bottle-type-edit');
    editButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            document.getElementById('bt-id').value = id;
            document.getElementById('bt-name').value = btn.dataset.name || '';
            document.getElementById('bt-capacity').value = btn.dataset.capacity || '';
            document.getElementById('bt-price').value = btn.dataset.price || '';
            document.getElementById('bt-deposit').value = btn.dataset.deposit || '';
            document.getElementById('bottle-type-create-row').classList.remove('d-none');
        });
    });
}
document.addEventListener('DOMContentLoaded', () => {
    loadBottleTypes();

    const row = document.getElementById('bottle-type-create-row');
    const showBtn = document.getElementById('show-bottle-type-create');
    const hideBtn = document.getElementById('hide-bottle-type-create');
    const form = document.getElementById('bottle-type-form');

    if (showBtn && row && hideBtn && form) {
        showBtn.addEventListener('click', () => {
            row.classList.remove('d-none');
            document.getElementById('bt-id').value = '';
            form.reset();
        });
        hideBtn.addEventListener('click', () => {
            row.classList.add('d-none');
        });
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const idVal = document.getElementById('bt-id').value;
            const name = document.getElementById('bt-name').value.trim();
            const capacity = document.getElementById('bt-capacity').value;
            const price = document.getElementById('bt-price').value;
            const deposit = document.getElementById('bt-deposit').value;

            if (!name) {
                alert('Le nom du type est obligatoire.');
                return;
            }

            const payload = {
                name: name,
                capacity_kg: capacity,
                price_mru: price,
                deposit_mru: deposit,
            };

            const isEdit = !!idVal;
            const url = isEdit ? (apiBase + 'bottle-types/' + idVal + '/') : (apiBase + 'bottle-types/');
            const method = isEdit ? 'PATCH' : 'POST';
            const errorMessage = isEdit ? 'Erreur lors de la mise à jour du type de bouteille' : 'Erreur lors de la création du type de bouteille';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(payload),
            })
            .then(r => {
                if (!r.ok) throw new Error(errorMessage);
                return r.json();
            })
            .then(() => {
                document.getElementById('bt-id').value = '';
                form.reset();
                row.classList.add('d-none');
                loadBottleTypes();
            })
            .catch(err => {
                console.error(err);
                alert("Impossible d'enregistrer le type de bouteille: " + err.message);
            });
        });
    }
});
</script>
{% endblock %}
