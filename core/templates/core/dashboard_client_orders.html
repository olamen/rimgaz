{% extends "core/dashboard_base.html" %}

{% block page_title %}Commandes clients{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card card-primary card-outline">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">Commandes clients</h3>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover" id="orders-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Type de bouteille</th>
                            <th>Quantité</th>
                            <th>Total (MRU)</th>
                            <th>Statut</th>
                            <th>Date</th>
                            <th style="width: 140px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadClientOrders() {
    const res = await fetch(apiBase + 'client-orders/');
    if (!res.ok) return;
    const data = await res.json();
    const tbody = document.querySelector('#orders-table tbody');
    tbody.innerHTML = '';
    data.forEach(o => {
        const bottle = o.bottle_type;
        const bottleLabel = bottle ? `${bottle.name} (${bottle.capacity_kg}kg)` : 'Inconnu';
        const actions = o.status === 'pending'
            ? `<button class="btn btn-xs btn-success me-1" data-action="validate" data-id="${o.id}">Valider</button>
               <button class="btn btn-xs btn-danger" data-action="cancel" data-id="${o.id}">Annuler</button>`
            : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${o.client || ''}</td>
            <td>${bottleLabel}</td>
            <td>${o.quantity}</td>
            <td>${o.total_price_mru}</td>
            <td>${o.status}</td>
            <td>${o.created_at}</td>
            <td>${actions}</td>
        `;
        tbody.appendChild(tr);
    });
}
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
    loadClientOrders();

    const tbody = document.querySelector('#orders-table tbody');
    tbody.addEventListener('click', function (e) {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        const newStatus = action === 'validate' ? 'validated' : 'cancelled';

        fetch(apiBase + 'client-orders/' + id + '/', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ status: newStatus }),
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(errData => {
                    const msg = errData && errData.detail ? errData.detail : 'Erreur mise à jour commande';
                    throw new Error(msg);
                }).catch(() => {
                    throw new Error('Erreur mise à jour commande');
                });
            }
            return r.json();
        })
        .then(() => loadClientOrders())
        .catch(err => {
            console.error(err);
            alert(err.message || 'Erreur mise à jour commande');
        });
    });
});
</script>
{% endblock %}
